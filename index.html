<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking Ballot</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        .header {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            padding: 1rem 0;
            text-align: center;
            border-bottom-left-radius: 0.75rem; /* rounded-bl-xl */
            border-bottom-right-radius: 0.75rem; /* rounded-br-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background-color: #6366f1; /* Indigo-500 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #4f46e5; /* Indigo-600 */
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-secondary {
            background-color: #e0e7ff; /* Indigo-100 */
            color: #4f46e5; /* Indigo-600 */
        }
        .btn-secondary:hover {
            background-color: #c7d2fe; /* Indigo-200 */
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-danger {
            background-color: #ef4444; /* Red-500 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* Red-600 */
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .form-input, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db; /* Gray-300 */
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #6366f1; /* Indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: separate; /* Use separate to apply border-radius to cells */
            border-spacing: 0; /* Remove space between cell borders */
            margin-top: 1rem;
        }
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb; /* Gray-200 */
        }
        th {
            background-color: #f3f4f6; /* Gray-100 */
            font-weight: 600;
            color: #4b5563; /* Gray-700 */
        }
        tr:last-child td {
            border-bottom: none;
        }
        tbody tr:hover {
            background-color: #f9fafb; /* Gray-50 */
        }
        .ranking-item {
            /* Default styles for ranking items */
        }
        .ranking-item:nth-child(odd) {
            background-color: #f8fafc; /* Blue Gray-50 */
        }
        .ranking-item:nth-child(even) {
            background-color: white;
        }
        .ranking-item td {
            padding: 0.75rem 1rem;
        }
        .ranking-item.top-rank {
            font-weight: bold;
            color: #4f46e5; /* Indigo-600 */
            background-color: #fff9e6; /* Light yellow */
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toast-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1000;
        }
        .toast-message.show {
            opacity: 1;
        }
        /* Modal styles (used for Logout and Delete, and also as base for global loading) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Default for modals */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        /* General modal content styling for white background */
        .modal-content {
            background-color: white; /* Set background to white */
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        /* Style for the transparent action loading overlay */
        #actionLoadingOverlay {
            background-color: rgba(255, 255, 255, 0.7); /* Transparent white background */
        }
        /* Style for the content inside actionLoadingOverlay (no background/shadow here) */
        #actionLoadingOverlay .flex-col {
            background-color: transparent;
            box-shadow: none;
        }
        /* Specific style for announcement modal content (overrides only width for user-facing) */
        #announcementModal .modal-content {
            width: 100%;
            max-width: 480px; /* Adjust max-width as needed */
        }
        /* New styles for admin sub-pages (Ballot Input and Announcement Management) */
        .admin-sub-page {
            display: none; /* Hidden by default */
            flex-direction: column;
            width: 100%;
        }
        .admin-sub-page.active {
            display: flex;
        }
        .announcement-card {
            background-color: #f8f9fa;
            border: 1px solid #e0e7ff;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .announcement-card .info-icon {
            position: absolute;
            top: 1rem;
            left: 1rem;
            color: #6366f1;
            cursor: pointer;
            font-size: 1.25rem;
        }
        .announcement-card .timestamp {
            font-size: 0.75rem;
            color: #6b7280;
            text-align: right;
            margin-top: 1rem;
        }
        .announcement-info-popup {
            position: absolute;
            background-color: #333;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            top: 2.5rem; /* Adjust position relative to icon */
            left: 1rem;
        }
        .announcement-card .info-icon:hover + .announcement-info-popup {
            opacity: 1;
            pointer-events: auto;
        }
        /* New styles for display off modal */
        #displayOffModal .modal-content {
            background-color: #fef2f2; /* Red-50 */
            border: 1px solid #ef4444; /* Red-500 */
            color: #b91c1c; /* Red-700 */
        }
        #displayOffModal .modal-content h4 {
            color: #b91c1c;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- Header -->
    <header class="header">
        <h1 class="text-3xl font-extrabold mb-1">Perolehan Ballot</h1>
        <h2 class="text-xl font-semibold mb-1">LKBB ANGKASA SEASON 2</h2>
        <p class="text-lg font-medium">SMA NEGERI 1 BANGSAL</p>
    </header>

    <div class="container">
        <!-- Homepage -->
        <div id="homePage" class="flex flex-col items-center justify-center min-h-screen-minus-header">
            <h3 class="text-2xl font-bold mb-8 text-center">Hasil Perolehan Ballot<br>Silakan Pilih Tindakan</h3>
            <div class="space-y-4">
                <button id="viewBallotBtn" class="btn btn-primary w-full md:w-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                    </svg>
                    Lihat Ballot
                </button>
                <button id="loginBtn" class="btn btn-secondary w-full md:w-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                    </svg>
                    Login
                </button>
            </div>
        </div>

        <!-- Login Page -->
        <div id="loginPage" class="hidden flex flex-col items-center justify-center min-h-screen-minus-header">
            <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
                <h3 class="text-2xl font-bold mb-6 text-center text-indigo-700">Login Admin</h3>
                <div class="mb-4">
                    <label for="username" class="block text-gray-700 text-sm font-semibold mb-2">Username Admin:</label>
                    <input type="text" id="username" class="form-input" placeholder="Masukkan Username Admin Anda (Email)">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 text-sm font-semibold mb-2">Password:</label>
                    <input type="password" id="password" class="form-input" placeholder="Masukkan Password">
                </div>
                <button id="submitLoginBtn" class="btn btn-primary w-full">Login</button>
                <p id="loginError" class="text-red-500 text-sm mt-4 text-center hidden">Username atau password salah!</p>
                <button id="backToHomeFromLogin" class="btn btn-secondary w-full mt-4">Kembali ke Beranda</button>
            </div>
        </div>

        <!-- Admin Page (Main Hub) -->
        <div id="adminPage" class="hidden flex-col items-center justify-center min-h-screen-minus-header">
            <h3 class="text-2xl font-bold mb-8 text-center">Panel Admin<br>Pilih Aksi</h3>
            <div class="space-y-4">
                <button id="goToBallotInputBtn" class="btn btn-primary w-full md:w-auto text-xl px-6 py-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 011 1v8a1 1 0 01-1 1H5a1 1 0 01-1-1V7z" />
                    </svg>
                    Input Ballot
                </button>
                <button id="goToAnnouncementManagementBtn" class="btn btn-secondary w-full md:w-auto text-xl px-6 py-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.041 0 01-4.083-.98L2 17l1.336-3.111A4 4 0 004 13H2c-.662 0-1-2.67-1-6S1.338 0 2 0h16c.662 0 1 .67 1 6s-.338 7-1 7z" clip-rule="evenodd" />
                    </svg>
                    Siarkan Informasi
                </button>
            </div>
            <div class="flex flex-col md:flex-row gap-4 mt-8 w-full">
                <button id="logoutBtn" class="btn btn-secondary w-full md:w-1/2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
                    </svg>
                    Logout
                </button>
                <!-- Back to Home Button on Admin Panel -->
                <button id="backToHomeFromAdminHubBtn" class="btn btn-secondary w-full md:w-1/2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>
                    Kembali ke Beranda
                </button>
            </div>
        </div>

        <!-- Ballot Input Page (Sub-page of Admin) -->
        <div id="ballotInputPage" class="admin-sub-page">
            <h3 class="text-2xl font-bold mb-6 text-center text-indigo-700">Input Data Sekolah</h3>
            <div class="flex flex-col md:flex-row gap-6">
                <!-- SMP/MTs Input -->
                <div class="md:w-1/2 w-full bg-white p-6 rounded-xl shadow-md">
                    <h4 class="text-xl font-semibold mb-4 text-center text-emerald-700">Tingkat SMP/MTs</h4>
                    <p id="smpAdminLastUpdated" class="text-xs text-gray-500 mt-2 text-right">Diperbarui pada: -</p>
                    <div class="mb-4">
                        <label for="smpName" class="block text-gray-700 text-sm font-semibold mb-2">Nama Sekolah:</label>
                        <input type="text" id="smpName" class="form-input" placeholder="Contoh: SMPN 1 Jakarta">
                    </div>
                    <div class="mb-4">
                        <label for="smpPoints" class="block text-gray-700 text-sm font-semibold mb-2">Poin Ballot:</label>
                        <input type="number" id="smpPoints" class="form-input" placeholder="Contoh: 100">
                    </div>
                    <button id="addSmpBtn" class="btn btn-primary w-full mt-2">Tambah/Update SMP</button>

                    <div class="table-container mt-6">
                        <table class="min-w-full bg-white rounded-lg shadow">
                            <thead>
                                <tr>
                                    <th class="py-3 px-4 text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tl-lg">Nama Sekolah</th>
                                    <th class="py-3 px-4 text-sm font-medium text-gray-600 uppercase tracking-wider">Poin Ballot</th>
                                    <th class="py-3 px-4 text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tr-lg">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="smpTableBody">
                                <!-- SMP data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- SMA/SMK/MA Input -->
                <div class="md:w-1/2 w-full bg-white p-6 rounded-xl shadow-md">
                    <h4 class="text-xl font-semibold mb-4 text-center text-orange-700">Tingkat SMA/SMK/MA</h4>
                    <p id="smaAdminLastUpdated" class="text-xs text-gray-500 mt-2 text-right">Diperbarui pada: -</p>
                    <div class="mb-4">
                        <label for="smaName" class="block text-gray-700 text-sm font-semibold mb-2">Nama Sekolah:</label>
                        <input type="text" id="smaName" class="form-input" placeholder="Contoh: SMAN 8 Bandung">
                    </div>
                    <div class="mb-4">
                        <label for="smaPoints" class="block text-gray-700 text-sm font-semibold mb-2">Poin Ballot:</label>
                        <input type="number" id="smaPoints" class="form-input" placeholder="Contoh: 120">
                    </div>
                    <button id="addSmaBtn" class="btn btn-primary w-full mt-2">Tambah/Update SMA</button>

                    <div class="table-container mt-6">
                        <table class="min-w-full bg-white rounded-lg shadow">
                            <thead>
                                <tr>
                                    <th class="py-3 px-4 text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tl-lg">No</th>
                                    <th class="py-3 px-4 text-sm font-medium text-gray-600 uppercase tracking-wider">Poin</th>
                                    <th class="py-3 px-4 text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tr-lg">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="smaTableBody">
                                <!-- SMA data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Display Control Section -->
            <div class="w-full bg-white p-6 rounded-xl shadow-md text-center mt-6">
                <h4 class="text-xl font-semibold mb-4 text-indigo-700">Kontrol Tampilan Ranking</h4>
                <p id="displayStatus" class="text-lg font-bold mb-4">Status: Memuat...</p>
                <div class="flex flex-col md:flex-row justify-center space-y-2 md:space-y-0 md:space-x-4">
                    <button id="activateDisplayBtn" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        Aktifkan Display Ranking
                    </button>
                    <button id="deactivateDisplayBtn" class="btn btn-danger">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                        Nonaktifkan Display Ranking
                    </button>
                </div>
            </div>


            <div class="flex flex-col md:flex-row gap-4 mt-6 w-full">
                <button id="logoutFromBallotBtn" class="btn btn-secondary w-full md:w-1/2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
                    </svg>
                    Logout
                </button>
                <button id="backToAdminHubFromBallotBtn" class="btn btn-secondary w-full md:w-1/2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>
                    Kembali ke Admin Panel
                </button>
            </div>
        </div>

        <!-- Announcement Management Page (Sub-page of Admin) -->
        <div id="announcementManagementPage" class="admin-sub-page">
            <h3 class="text-2xl font-bold mb-6 text-center text-indigo-700">Siarkan Informasi</h3>
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Input Form for Announcement -->
                <div class="md:w-1/2 w-full bg-white p-6 rounded-xl shadow-md">
                    <h4 class="text-xl font-semibold mb-4 text-center text-indigo-700">Buat / Edit Informasi</h4>
                    <div class="mb-4">
                        <label for="announcementHeading" class="block text-gray-700 text-sm font-semibold mb-2">Masukkan Heading Informasi:</label>
                        <input type="text" id="announcementHeading" class="form-input" placeholder="Contoh: Pengumuman Penting!">
                    </div>
                    <div class="mb-4">
                        <label for="announcementContent" class="block text-gray-700 text-sm font-semibold mb-2">Masukkan Pengumuman:</label>
                        <textarea id="announcementContent" class="form-textarea h-32" placeholder="Tulis pengumuman Anda di sini..."></textarea>
                    </div>

                    <div class="mb-4 flex items-center">
                        <input type="checkbox" id="publishNowCheckbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="publishNowCheckbox" class="ml-2 block text-sm font-medium text-gray-900">Siarkan Sekarang Juga (Realtime)</label>
                    </div>

                    <div id="scheduleTimeSection" class="mb-4 p-4 border border-gray-200 rounded-lg bg-gray-50 hidden">
                        <label for="scheduledPublishTime" class="block text-gray-700 text-sm font-semibold mb-2">Siarkan pada (Tanggal & Waktu):</label>
                        <input type="datetime-local" id="scheduledPublishTime" class="form-input">
                        <p class="text-xs text-gray-500 mt-1">Waktu akan menggunakan zona waktu lokal browser Anda.</p>
                    </div>

                    <div class="mb-6 flex items-center">
                        <input type="checkbox" id="includeTimestampCheckbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked>
                        <label for="includeTimestampCheckbox" class="ml-2 block text-sm font-medium text-gray-900">Sertakan Tanggal dan Jam Informasi Saat Ini</label>
                    </div>
                    
                    <!-- Generate Announcement Button -->
                    <button id="generateAnnouncementBtn" class="btn btn-secondary w-full mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V4a2 2 0 00-2-2H6zM4 14a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2zM14 4a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V6a2 2 0 00-2-2h-2zM12 14a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2h-2a2 2 0 00-2 2v2z" clip-rule="evenodd" />
                        </svg>
                        Buat Saran Informasi (AI)
                    </button>

                    <button id="saveAnnouncementBtn" class="btn btn-primary w-full mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h-1v5.586l-1.293-1.293z" />
                            <path d="M9 2a1 1 0 00-1 1v2a1 1 0 002 0V3a1 1 0 00-1-1zM3 8a1 1 0 011-1h2a1 1 0 110 2H4a1 1 0 01-1-1zM9 17a1 1 0 001 1h2a1 1 0 100-2h-2a1 1 0 00-1 1zM15 8a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1zM5 14a1 1 0 011-1h.01a1 1 0 011.414 0 1 1 0 010 1.414L6.414 16H6a1 1 0 01-1-1zm8-1a1 1 0 011 1v.01a1 1 0 01-1.414 0 1 1 0 010-1.414L13.586 12H14a1 1 0 01-1-1z" />
                        </svg>
                        Simpan Informasi
                    </button>
                    <button id="clearAnnouncementBtn" class="btn btn-secondary w-full mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        Bersihkan Form
                    </button>
                </div>

                <!-- Current Announcement Display -->
                <div class="md:w-1/2 w-full bg-white p-6 rounded-xl shadow-md relative">
                    <h4 class="text-xl font-semibold mb-4 text-center text-indigo-700">Informasi Saat Ini</h4>
                    <div id="currentAnnouncementDisplay" class="announcement-card min-h-[150px] flex flex-col justify-between">
                        <div class="info-icon" title="Keterangan Aktivitas">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9.293 10.293a1 1 0 001.414 1.414L11 10.414V14a1 1 0 102 0v-4a1 1 0 00-.293-.707l-1.414-1.414a1 1 0 00-1.414 0z" clip-rule="evenodd" />
                            </svg>
                            <div class="announcement-info-popup"></div>
                        </div>
                        <p id="displayAnnouncementHeading" class="text-xl font-bold mb-2 text-center text-gray-800">Tidak Ada Informasi Saat Ini</p>
                        <p id="displayAnnouncementContent" class="text-gray-700 text-center flex-grow">
                            Belum ada pengumuman yang disiarkan.
                        </p>
                        <p id="displayAnnouncementTimestamp" class="timestamp hidden"></p>
                        <div class="flex justify-center space-x-2 mt-4">
                            <button id="editCurrentAnnouncementBtn" class="btn btn-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                    <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                                </svg>
                                Edit
                            </button>
                            <button id="deleteCurrentAnnouncementBtn" class="btn btn-danger">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                                Hapus
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex flex-col md:flex-row gap-4 mt-6 w-full">
                <button id="logoutFromAnnouncementBtn" class="btn btn-secondary w-full md:w-1/2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
                    </svg>
                    Logout
                </button>
                <button id="backToAdminHubFromAnnouncementBtn" class="btn btn-secondary w-full md:w-1/2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>
                    Kembali ke Admin Panel
                </button>
            </div>
        </div>


        <!-- Ranking Display Page -->
        <div id="rankingPage" class="hidden flex flex-col items-center justify-center min-h-screen-minus-header">
            <div id="loadingAnimation" class="flex flex-col items-center justify-center p-8 bg-white rounded-xl shadow-lg">
                <div class="loading-spinner mb-4"></div>
                <p id="loadingText" class="text-lg font-medium text-gray-700">Sebentar, ya. Poinnya lagi dimasukin<span id="loadingDots">...</span></p>
            </div>

            <div id="rankingContent" class="hidden w-full">
                <h3 class="text-2xl font-bold mb-6 text-center text-indigo-700">Hasil Perolehan Ballot</h3>
                <div class="mb-4 w-full max-w-md mx-auto">
                    <label for="schoolSearch" class="sr-only">Cari Sekolah</label>
                    <input type="text" id="schoolSearch" class="form-input" placeholder="Cari nama sekolah...">
                </div>
                <div class="flex flex-col md:flex-row gap-6 w-full">
                    <!-- SMP/MTs Ranking Display -->
                    <div class="md:w-1/2 w-full bg-white p-6 rounded-xl shadow-md">
                        <h4 class="text-xl font-semibold mb-4 text-center text-emerald-700">Ranking SMP/MTs</h4>
                        <p id="smpRankingLastUpdated" class="text-xs text-gray-500 mt-2 text-right"> Poin sudah diperbarui pada: -</p>
                        <div class="table-container">
                            <table class="min-w-full bg-white rounded-lg shadow">
                                <thead>
                                    <tr>
                                        <!-- Removed "No" column -->
                                        <th class="py-3 px-4 text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tl-lg">Nama Sekolah</th>
                                        <th class="py-3 px-4 text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tr-lg">Ballot</th>
                                    </tr>
                                </thead>
                                <tbody id="displaySmpRanking">
                                    <!-- SMP rankings will be displayed here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- SMA/SMK/MA Ranking Display -->
                    <div class="md:w-1/2 w-full bg-white p-6 rounded-xl shadow-md">
                        <h4 class="text-xl font-semibold mb-4 text-center text-orange-700">Ranking SMA/SMK/MA</h4>
                        <p id="smaRankingLastUpdated" class="text-xs text-gray-500 mt-2 text-right">Poin sudah diperbarui pada: -</p>
                        <div class="table-container">
                            <table class="min-w-full bg-white rounded-lg shadow">
                                <thead>
                                    <tr>
                                        <!-- Removed "No" column -->
                                        <th class="py-3 px-4 text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tl-lg">Nama Sekolah</th>
                                        <th class="py-3 px-4 text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tr-lg">Ballot</th>
                                    </tr>
                                </thead>
                                <tbody id="displaySmaRanking">
                                    <!-- SMA rankings will be displayed here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <button id="backToHomeFromRanking" class="btn btn-secondary w-full mt-6">Kembali ke Beranda</button>
            </div>
        </div>
    </div>

    <!-- Toast Message Container -->
    <div id="toastMessage" class="toast-message"></div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h4 class="text-xl font-semibold mb-6">Ingin melanjutkan tindakan?</h4>
            <div class="flex justify-center space-x-4">
                <button id="confirmLogoutBtn" class="btn btn-primary">Keluar</button>
                <button id="cancelLogoutBtn" class="btn btn-secondary">Tetap di sini</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h4 class="text-xl font-semibold mb-4">Konfirmasi Penghapusan</h4>
            <p class="mb-6">Ingin menghapus <span id="deleteSchoolName" class="font-bold"></span>? Tindakan ini tidak dapat dipulihkan kembali!</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmDeleteBtn" class="btn btn-danger">Ya, Hapus</button>
                <button id="cancelDeleteBtn" class="btn btn-secondary">Batal</button>
            </div>
        </div>
    </div>

    <!-- Global Transparent Loading Overlay for non-ranking actions -->
    <div id="actionLoadingOverlay" class="modal-overlay hidden">
        <div class="flex flex-col items-center justify-center p-8 rounded-xl">
            <div class="loading-spinner mb-4"></div>
            <p class="text-lg font-medium text-gray-700">Tunggu Sebentar...</p>
        </div>
    </div>

    <!-- Announcement Modal (User-facing Pop-up) - HIDDEN BY DEFAULT -->
    <div id="announcementModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-sm p-6">
            <h4 id="userAnnouncementHeading" class="text-2xl font-bold text-indigo-700 mb-4">Informasi</h4>
            <p id="userAnnouncementContent" class="text-lg text-gray-700 mb-6">
                Halo Guys! Selamat datang di Web Ranking Ballot LKBB ANGKASA Season 2 :D<br>Hasil ballot akan segera diperbarui oleh admin. Kamu bisa melihat kapan poin diperbarui.<br>Pantengin terus, ya! XD
            </p>
            <p id="userAnnouncementTimestamp" class="text-xs text-gray-500 text-right mt-2 hidden"></p>
            <button id="closeAnnouncementBtn" class="btn btn-primary w-full">Siap</button>
        </div>
    </div>

    <!-- Display Off Modal -->
    <div id="displayOffModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h4 class="text-2xl font-bold mb-4">Gagal memuat data!</h4>
            <p class="text-lg mb-6">Sedang dalam perbaikan.<br>Mohon maaf atas ketidaknyamanannya.</p>
            <button id="backToHomeFromDisplayOff" class="btn btn-primary">Kembali ke Beranda</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, collection, setDoc, doc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
        import { serverTimestamp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js"; // Import serverTimestamp

        // Firebase configuration and initialization
        const firebaseConfig = {
            apiKey: "AIzaSyC0LcRmLgNiQKEXhTWJ8P_KU7AQhASGsMg",
            authDomain: "ranking-ballot-angkasa-app.firebaseapp.com",
            projectId: "ranking-ballot-angkasa-app",
            storageBucket: "ranking-ballot-angkasa-app.firebasestorage.app",
            messagingSenderId: "339138452646",
            appId: "1:339138452646:web:b4dfe4f9da7b36481ca867"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "ranking-ballot-angkasa-app"; 

        // >>>>>> PENTING: GANTI DENGAN ARRAY UID ADMIN ANDA DARI FIREBASE CONSOLE! <<<<<<
        // Contoh: const ADMIN_UIDS = ["uidAdmin1", "uidAdmin2", "uidAdmin3"];
        const ADMIN_UIDS = ["VKcLHqNIohR0i6gcQX4uli6ehI52","YaONmdWM2cTwzovwbs2rTQMHnft1"]; // GANTI DENGAN ARRAY UID ADMIN ASLI!

        let currentUserId = null;
        let isAdminLoggedIn = false;
        let smpSchoolsData = []; // To store all SMP data from Firestore
        let smaSchoolsData = []; // To store all SMA data from Firestore
        let currentSearchQuery = '';
        let currentAnnouncement = null; // To store the current active announcement
        let displayRankingActive = true; // Global state for ranking display visibility (default: true)

        // Variables for delete modal context
        let schoolToDeleteType = null;
        let schoolToDeleteId = null;

        // --- UI Element References ---
        const homePage = document.getElementById('homePage');
        const loginPage = document.getElementById('loginPage');
        const adminPage = document.getElementById('adminPage');
        const rankingPage = document.getElementById('rankingPage');
        const loadingAnimation = document.getElementById('loadingAnimation'); // For ranking page specific loading
        const rankingContent = document.getElementById('rankingContent');
        const loadingDots = document.getElementById('loadingDots'); // For dot animation

        // Admin Sub-pages
        const ballotInputPage = document.getElementById('ballotInputPage');
        const announcementManagementPage = document.getElementById('announcementManagementPage');

        const viewBallotBtn = document.getElementById('viewBallotBtn');
        const loginBtn = document.getElementById('loginBtn');
        const backToHomeFromLogin = document.getElementById('backToHomeFromLogin');
        const backToHomeFromRanking = document.getElementById('backToHomeFromRanking');
        const logoutBtn = document.getElementById('logoutBtn'); // Main logout button on admin hub

        // Admin Hub Buttons
        const goToBallotInputBtn = document.getElementById('goToBallotInputBtn');
        const goToAnnouncementManagementBtn = document.getElementById('goToAnnouncementManagementBtn');
        
        // Back to Home Button from Admin Hub
        const backToHomeFromAdminHubBtn = document.getElementById('backToHomeFromAdminHubBtn');

        // Logout buttons for sub-pages
        const logoutFromBallotBtn = document.getElementById('logoutFromBallotBtn');
        const logoutFromAnnouncementBtn = document.getElementById('logoutFromAnnouncementBtn');

        // Back to Admin Hub buttons for sub-pages
        const backToAdminHubFromBallotBtn = document.getElementById('backToAdminHubFromBallotBtn');
        const backToAdminHubFromAnnouncementBtn = document.getElementById('backToAdminHubFromAnnouncementBtn');


        const usernameInput = document.getElementById('username'); // Digunakan untuk email admin
        const passwordInput = document.getElementById('password');
        const submitLoginBtn = document.getElementById('submitLoginBtn');
        const loginError = document.getElementById('loginError');

        const smpNameInput = document.getElementById('smpName');
        const smpPointsInput = document.getElementById('smpPoints');
        const addSmpBtn = document.getElementById('addSmpBtn');
        const smpTableBody = document.getElementById('smpTableBody');
        const smpAdminLastUpdated = document.getElementById('smpAdminLastUpdated');

        const smaNameInput = document.getElementById('smaName');
        const smaPointsInput = document.getElementById('smaPoints');
        const addSmaBtn = document.getElementById('addSmaBtn');
        const smaTableBody = document.getElementById('smaTableBody');
        const smaAdminLastUpdated = document.getElementById('smaAdminLastUpdated');

        const displaySmpRanking = document.getElementById('displaySmpRanking');
        const displaySmaRanking = document.getElementById('displaySmaRanking');
        const smpRankingLastUpdated = document.getElementById('smpRankingLastUpdated');
        const smaRankingLastUpdated = document.getElementById('smaRankingLastUpdated');

        const schoolSearchInput = document.getElementById('schoolSearch');
        const toastMessage = document.getElementById('toastMessage');

        // Modals
        const logoutModal = document.getElementById('logoutModal');
        const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
        const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');
        const deleteModal = document.getElementById('deleteModal');
        const deleteSchoolNameSpan = document.getElementById('deleteSchoolName');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const actionLoadingOverlay = document.getElementById('actionLoadingOverlay');

        // Announcement Management Elements
        const announcementHeadingInput = document.getElementById('announcementHeading');
        const announcementContentInput = document.getElementById('announcementContent');
        const publishNowCheckbox = document.getElementById('publishNowCheckbox');
        const scheduleTimeSection = document.getElementById('scheduleTimeSection');
        const scheduledPublishTimeInput = document.getElementById('scheduledPublishTime');
        const includeTimestampCheckbox = document.getElementById('includeTimestampCheckbox');
        const saveAnnouncementBtn = document.getElementById('saveAnnouncementBtn'); 
        const clearAnnouncementBtn = document.getElementById('clearAnnouncementBtn');
        const generateAnnouncementBtn = document.getElementById('generateAnnouncementBtn'); // Generate button
        
        const currentAnnouncementDisplay = document.getElementById('currentAnnouncementDisplay');
        const displayAnnouncementHeading = document.getElementById('displayAnnouncementHeading');
        const displayAnnouncementContent = document.getElementById('displayAnnouncementContent');
        const displayAnnouncementTimestamp = document.getElementById('displayAnnouncementTimestamp');
        const editCurrentAnnouncementBtn = document.getElementById('editCurrentAnnouncementBtn');
        const deleteCurrentAnnouncementBtn = document.getElementById('deleteCurrentAnnouncementBtn');
        const announcementInfoPopup = currentAnnouncementDisplay.querySelector('.announcement-info-popup');

        // User-facing Announcement Modal Elements
        const announcementModal = document.getElementById('announcementModal');
        const closeAnnouncementBtn = document.getElementById('closeAnnouncementBtn');
        const userAnnouncementHeading = document.getElementById('userAnnouncementHeading');
        const userAnnouncementContent = document.getElementById('userAnnouncementContent');
        const userAnnouncementTimestamp = document.getElementById('userAnnouncementTimestamp');

        // Default announcement content for user-facing modal
        const defaultAnnouncementHeading = "Informasi";
        const defaultAnnouncementContent = "Halo Guys! Selamat datang di Web Ranking Ballot LKBB ANGKASA Season 2 :D<br>Hasil ballot akan segera diperbarui oleh admin. Kamu bisa melihat kapan poin diperbarui.<br>Pantengin terus, ya! XD";

        // Previous state for user-facing announcement to trigger re-pop
        let previousUserAnnouncementHeading = "";
        let previousUserAnnouncementContentRaw = ""; // Store raw for comparison
        let previousUserAnnouncementIsActive = false; // True if it was displaying an admin-published announcement

        // Display Control Elements
        const displayStatus = document.getElementById('displayStatus');
        const activateDisplayBtn = document.getElementById('activateDisplayBtn');
        const deactivateDisplayBtn = document.getElementById('deactivateDisplayBtn');
        
        // Firestore document reference for app settings
        const appSettingsDocRef = doc(db, `artifacts/${appId}/public/data/app_settings`, 'display_control');

        // Display Off Modal Elements
        const displayOffModal = document.getElementById('displayOffModal');
        const backToHomeFromDisplayOff = document.getElementById('backToHomeFromDisplayOff');


        // --- Navigation Functions ---
        function showPage(pageToShow) {
            // Hide all main pages and admin sub-pages
            homePage.classList.add('hidden');
            loginPage.classList.add('hidden');
            adminPage.classList.add('hidden');
            rankingPage.classList.add('hidden');
            ballotInputPage.classList.remove('active'); // Hide sub-page
            announcementManagementPage.classList.remove('active'); // Hide sub-page
            displayOffModal.classList.add('hidden'); // Ensure display off modal is hidden

            // Remove flex display from all pages to ensure correct hidden state
            homePage.classList.remove('flex');
            loginPage.classList.remove('flex');
            adminPage.classList.remove('flex', 'flex-col');
            rankingPage.classList.remove('flex', 'flex-col');

            // Show the requested page and add flex display if needed
            pageToShow.classList.remove('hidden');
            if (pageToShow === homePage || pageToShow === loginPage || pageToShow === adminPage || pageToShow === rankingPage) {
                pageToShow.classList.add('flex', 'flex-col');
            } else if (pageToShow === ballotInputPage || pageToShow === announcementManagementPage) {
                // For admin sub-pages, they are already flex-col by default CSS, just need 'active' class
                pageToShow.classList.add('active');
            }
        }

        // Fungsi untuk menampilkan sub-page admin
        function showAdminSubPage(subPageToShow) {
            // Sembunyikan semua sub-page admin
            ballotInputPage.classList.remove('active');
            announcementManagementPage.classList.remove('active');

            // Tampilkan sub-page yang diminta
            subPageToShow.classList.add('active');
            adminPage.classList.remove('flex', 'flex-col'); // Hide main admin hub
            adminPage.classList.add('hidden'); // Ensure main admin hub is hidden
        }


        // --- Toast Notification ---
        function showToast(message, duration = 3000) {
            toastMessage.textContent = message;
            toastMessage.classList.add('show');
            setTimeout(() => {
                toastMessage.classList.remove('show');
            }, duration);
        }

        // --- Logout Modal Functions ---
        function showLogoutModal() {
            logoutModal.classList.remove('hidden');
        }

        function hideLogoutModal() {
            logoutModal.classList.add('hidden');
        }

        // --- Delete Modal Functions ---
        function showDeleteModal(name, type, id) {
            schoolToDeleteType = type;
            schoolToDeleteId = id;
            deleteSchoolNameSpan.textContent = name;
            deleteModal.classList.remove('hidden');
        }

        function hideDeleteModal() {
            schoolToDeleteType = null;
            schoolToDeleteId = null;
            deleteSchoolNameSpan.textContent = '';
            deleteModal.classList.add('hidden');
        }

        // --- Global Action Loading Functions ---
        function showActionLoading(message = "Tunggu Sebentar...") {
            actionLoadingOverlay.querySelector('p').textContent = message;
            actionLoadingOverlay.classList.remove('hidden');
        }

        function hideActionLoading() {
            actionLoadingOverlay.classList.add('hidden');
        }

        // --- Utility for Formatting Date ---
        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            let date;
            if (timestamp.toDate) { // Firestore Timestamp object
                date = timestamp.toDate();
            } else if (timestamp instanceof Date) { // Standard Date object
                date = timestamp;
            } else {
                return '-'; // Invalid timestamp format
            }
            return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) + ' ' +
                   date.toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function formatDateOnly(timestamp) {
            if (!timestamp) return '-';
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else if (timestamp instanceof Date) {
                date = timestamp;
            } else {
                return '-';
            }
            return date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function formatTimeOnly(timestamp) {
            if (!timestamp) return '-';
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else if (timestamp instanceof Date) {
                date = timestamp;
            } else {
                return '-';
            }
            return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        // --- Loading Dot Animation ---
        let dotInterval;
        function startDotAnimation() {
            let dots = '';
            let dotCount = 0;
            dotInterval = setInterval(() => {
                dots = '.'.repeat(dotCount % 4); // Cycles . .. ... (empty)
                loadingDots.textContent = dots;
                dotCount++;
            }, 500); // Change dot every 500ms
        }

        function stopDotAnimation() {
            clearInterval(dotInterval);
            loadingDots.textContent = ''; // Clear dots when animation stops
        }

        // --- Event Listeners ---
        viewBallotBtn.addEventListener('click', () => {
            showPage(rankingPage);
            loadingAnimation.classList.remove('hidden'); // Show loading immediately
            rankingContent.classList.add('hidden'); // Hide content initially
            displayOffModal.classList.add('hidden'); // Ensure display off modal is hidden
            startDotAnimation();

            // Simulate loading time (random between 3 to 5 seconds)
            const randomLoadTime = Math.floor(Math.random() * (5000 - 3000 + 1)) + 3000;
            setTimeout(() => {
                stopDotAnimation();
                finalizeRankingDisplay(); // Decide what to show after loading
            }, randomLoadTime);
        });

        loginBtn.addEventListener('click', () => {
            if (isAdminLoggedIn) {
                showPage(adminPage); // Go to Admin Hub if already logged in
            } else {
                showPage(loginPage);
                loginError.classList.add('hidden');
                usernameInput.value = '';
                passwordInput.value = '';
            }
        });

        // Admin Hub Navigation
        goToBallotInputBtn.addEventListener('click', () => {
            showAdminSubPage(ballotInputPage);
            fetchAndDisplayAdminData('smp_mts_schools', smpTableBody);
            fetchAndDisplayAdminData('sma_smk_ma_schools', smaTableBody);
            updateAdminDisplayStatusUI(); // Ensure display status is updated on this page
        });

        goToAnnouncementManagementBtn.addEventListener('click', () => {
            showAdminSubPage(announcementManagementPage);
            loadCurrentAnnouncementForAdminEdit(); // Load current announcement for editing
            updateAnnouncementDisplayForAdmin(); // Initial call to update countdown if any
            startCountdownUpdate(); // Start countdown update interval
        });

        // Back buttons
        backToHomeFromLogin.addEventListener('click', () => showPage(homePage));
        backToHomeFromRanking.addEventListener('click', () => {
            currentSearchQuery = '';
            schoolSearchInput.value = '';
            showPage(homePage);
        });
        backToHomeFromDisplayOff.addEventListener('click', () => showPage(homePage)); // for Display Off Modal

        // Back to Admin Hub buttons on sub-pages
        backToAdminHubFromBallotBtn.addEventListener('click', () => showPage(adminPage));
        backToAdminHubFromAnnouncementBtn.addEventListener('click', () => showPage(adminPage));

        // Back to Home button on main Admin Hub
        backToHomeFromAdminHubBtn.addEventListener('click', () => showPage(homePage));

        // Logout buttons (all trigger the same logout flow)
        logoutBtn.addEventListener('click', () => showLogoutModal()); // Main admin hub logout
        logoutFromBallotBtn.addEventListener('click', () => showLogoutModal());
        logoutFromAnnouncementBtn.addEventListener('click', () => showLogoutModal());


        confirmLogoutBtn.addEventListener('click', async () => {
            showActionLoading("Melakukan Logout...");
            try {
                await signOut(auth);
                isAdminLoggedIn = false;
                hideLogoutModal();
                showPage(homePage);
                showToast("Berhasil logout.");
            } catch (error) {
                console.error("Error logging out:", error);
                showToast("Gagal logout. Coba lagi.");
            } finally {
                hideActionLoading();
            }
        });

        cancelLogoutBtn.addEventListener('click', () => {
            hideLogoutModal();
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (schoolToDeleteType && schoolToDeleteId) {
                showActionLoading("Menghapus Data...");
                await executeDeleteSchool(schoolToDeleteType, schoolToDeleteId);
                hideActionLoading();
            }
            hideDeleteModal();
        });

        cancelDeleteBtn.addEventListener('click', () => {
            hideDeleteModal();
        });

        submitLoginBtn.addEventListener('click', async () => {
            showActionLoading("Mencoba Login...");
            const email = usernameInput.value;
            const password = passwordInput.value;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("Login berhasil! UID:", userCredential.user.uid);
                
                isAdminLoggedIn = ADMIN_UIDS.includes(userCredential.user.uid);
                
                if (!isAdminLoggedIn) {
                    showToast("Login berhasil, tetapi Anda bukan admin yang terdaftar.");
                    await signOut(auth); 
                    showPage(homePage);
                    return;
                }

                showPage(adminPage); // Go to Admin Hub
                loginError.classList.add('hidden');
                showToast("Login Admin Berhasil!");
            } catch (e) {
                console.error("Login gagal:", e.code, e.message);
                loginError.classList.remove('hidden');
                showToast("Login gagal. Username atau password salah!");
            } finally {
                hideActionLoading();
            }
        });

        schoolSearchInput.addEventListener('input', (e) => {
            currentSearchQuery = e.target.value;
            renderFilteredRankings();
        });

        // Toggle schedule time input visibility
        publishNowCheckbox.addEventListener('change', () => {
            if (publishNowCheckbox.checked) {
                scheduleTimeSection.classList.add('hidden');
                scheduledPublishTimeInput.value = ''; // Clear scheduled time if publish now is checked
            } else {
                scheduleTimeSection.classList.remove('hidden');
            }
        });


        // --- Firestore Operations (Admin) ---

        async function addSchool(type, name, points) {
            if (!isAdminLoggedIn || !ADMIN_UIDS.includes(currentUserId)) {
                showToast("Anda tidak memiliki izin untuk menambah data. Silakan login sebagai admin.");
                return;
            }
            if (!name || isNaN(points) || points === '') {
                showToast("Nama sekolah dan poin tidak boleh kosong.");
                return;
            }
            const parsedPoints = parseInt(points);
            if (parsedPoints < 0) {
                 showToast("Poin tidak boleh negatif.");
                 return;
            }
            if (currentUserId === null) {
                showToast("Autentikasi belum siap. Coba lagi.");
                return;
            }

            showActionLoading("Menyimpan Data Ballot...");
            const collectionPath = `artifacts/${appId}/public/data/${type}`;
            const schoolRef = doc(db, collectionPath, name.trim());

            try {
                await setDoc(schoolRef, {
                    name: name.trim(),
                    points: parsedPoints,
                    lastUpdated: serverTimestamp() // Gunakan serverTimestamp
                }, { merge: true });
                showToast(`Data ${name.trim()} berhasil ditambahkan/diperbarui.`);
                if (type === 'smp_mts_schools') {
                    smpNameInput.value = '';
                    smpPointsInput.value = '';
                } else {
                    smaNameInput.value = '';
                    smaPointsInput.value = '';
                }
            } catch (e) {
                console.error("Error adding document: ", e);
                showToast("Gagal menambahkan/memperbarui data. Periksa izin Anda.");
            } finally {
                hideActionLoading();
            }
        }

        async function executeDeleteSchool(type, docId) {
            if (!isAdminLoggedIn || !ADMIN_UIDS.includes(currentUserId)) {
                showToast("Anda tidak memiliki izin untuk menghapus data. Silakan login sebagai admin.");
                return;
            }
            if (currentUserId === null) {
                showToast("Autentikasi belum siap. Coba lagi.");
                return;
            }

            const collectionPath = `artifacts/${appId}/public/data/${type}`;
            try {
                await deleteDoc(doc(db, collectionPath, docId));
                showToast(`Data ${docId} berhasil dihapus.`);
            } catch (e) {
                console.error("Error removing document: ", e);
                showToast("Gagal menghapus data. Periksa izin Anda.");
            }
        }

        function fetchAndDisplayAdminData(collectionName, tableBodyElement) {
            if (currentUserId === null) {
                console.log("Firebase not yet authenticated for admin data fetch.");
                return;
            }
            if (!isAdminLoggedIn || !ADMIN_UIDS.includes(currentUserId)) {
                tableBodyElement.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">Anda tidak memiliki izin untuk melihat data ini.</td></tr>`;
                return;
            }

            const q = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
            onSnapshot(q, (snapshot) => {
                const schools = []; // Define schools locally within the callback
                let latestUpdateTimestamp = null;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    schools.push({ id: doc.id, ...data });
                    if (data.lastUpdated && (!latestUpdateTimestamp || data.lastUpdated.toDate() > latestUpdateTimestamp.toDate())) {
                        latestUpdateTimestamp = data.lastUpdated;
                    }
                });

                schools.sort((a, b) => a.name.localeCompare(b.name));

                tableBodyElement.innerHTML = '';
                if (schools.length === 0) {
                    tableBodyElement.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">Belum ada data sekolah.</td></tr>`;
                    if (collectionName === 'smp_mts_schools') {
                        smpAdminLastUpdated.textContent = 'Diperbarui pada: -';
                    } else if (collectionName === 'sma_smk_ma_schools') {
                        smaAdminLastUpdated.textContent = 'Diperbarui pada: -';
                    }
                    return;
                }

                schools.forEach(school => {
                    const row = tableBodyElement.insertRow();
                    row.innerHTML = `
                        <td class="py-2 px-4 text-sm">${school.name}</td>
                        <td class="py-2 px-4 text-sm">${school.points}</td>
                        <td class="py-2 px-4 text-sm flex space-x-2">
                            <button data-id="${school.id}" data-name="${school.name}" data-points="${school.points}" class="edit-btn text-blue-600 hover:text-blue-800 font-semibold">Edit</button>
                            <button data-id="${school.id}" data-name="${school.name}" class="delete-btn text-red-600 hover:text-red-800 font-semibold">Hapus</button>
                        </td>
                    `;
                });

                if (collectionName === 'smp_mts_schools') {
                    smpAdminLastUpdated.textContent = `Poin diperbarui pada: ${formatTimestamp(latestUpdateTimestamp)}`;
                } else if (collectionName === 'sma_smk_ma_schools') {
                    smaAdminLastUpdated.textContent = `Poin diperbarui pada: ${formatTimestamp(latestUpdateTimestamp)}`;
                }

                tableBodyElement.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        const name = e.target.dataset.name;
                        const points = e.target.dataset.points;
                        if (collectionName === 'smp_mts_schools') {
                            smpNameInput.value = name;
                            smpPointsInput.value = points;
                            smpNameInput.focus();
                            showToast(`Mengedit: ${name}`);
                        } else if (collectionName === 'sma_smk_ma_schools') {
                            smaNameInput.value = name;
                            smaPointsInput.value = points;
                            smaNameInput.focus();
                            showToast(`Mengedit: ${name}`);
                        }
                    });
                });

                tableBodyElement.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        const name = e.target.dataset.name;
                        showDeleteModal(name, collectionName, id);
                    });
                });
            }, (error) => {
                console.error("Error listening to admin data:", error);
                showToast("Gagal memuat data admin.");
            });
        }


        addSmpBtn.addEventListener('click', () => {
            addSchool('smp_mts_schools', smpNameInput.value, smpPointsInput.value);
        });

        addSmaBtn.addEventListener('click', () => {
            addSchool('sma_smk_ma_schools', smaNameInput.value, smaPointsInput.value);
        });

        // --- Announcement Management Functions ---

        // Load current announcement for admin to edit
        function loadCurrentAnnouncementForAdminEdit() {
            const announcementDocRef = doc(db, `artifacts/${appId}/public/data/announcements`, 'mainAnnouncement');
            onSnapshot(announcementDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentAnnouncement = data; // Store data globally
                    announcementHeadingInput.value = data.heading || '';
                    announcementContentInput.value = data.content || '';
                    includeTimestampCheckbox.checked = data.showTimestamp || false;

                    // Handle scheduling
                    if (data.publishAt && data.publishAt.toDate) { // If a publishAt timestamp exists
                        const publishDate = data.publishAt.toDate();
                        if (publishDate.getTime() > new Date().getTime()) { // If scheduled for future
                            publishNowCheckbox.checked = false;
                            scheduleTimeSection.classList.remove('hidden');
                            // Format date for datetime-local input (YYYY-MM-DDTHH:mm)
                            scheduledPublishTimeInput.value = publishDate.toISOString().substring(0, 16);
                        } else { // Already published (or publish now)
                            publishNowCheckbox.checked = true;
                            scheduleTimeSection.classList.add('hidden');
                            scheduledPublishTimeInput.value = '';
                        }
                    } else { // No specific publishAt, assume publish now
                        publishNowCheckbox.checked = true;
                        scheduleTimeSection.classList.add('hidden');
                        scheduledPublishTimeInput.value = '';
                    }
                } else {
                    // No announcement yet, clear form
                    currentAnnouncement = null;
                    announcementHeadingInput.value = '';
                    announcementContentInput.value = '';
                    publishNowCheckbox.checked = true; // Default to publish now
                    scheduleTimeSection.classList.add('hidden');
                    scheduledPublishTimeInput.value = '';
                    includeTimestampCheckbox.checked = true; // Default to include timestamp
                }
                updateAnnouncementDisplayForAdmin(); // Update right panel for admin
            }, (error) => {
                console.error("Error loading announcement for admin:", error);
                showToast("Gagal memuat informasi untuk admin.");
            });
        }

        // Display current announcement in the right panel of admin page
        function updateAnnouncementDisplayForAdmin() {
            if (!currentAnnouncement) {
                displayAnnouncementHeading.textContent = "Tidak Ada Informasi Saat Ini";
                displayAnnouncementContent.textContent = "Belum ada pengumuman yang disiarkan.";
                displayAnnouncementTimestamp.classList.add('hidden');
                announcementInfoPopup.textContent = "Tidak ada informasi aktif.";
                editCurrentAnnouncementBtn.disabled = true;
                deleteCurrentAnnouncementBtn.disabled = true;
                return;
            }

            editCurrentAnnouncementBtn.disabled = false;
            deleteCurrentAnnouncementBtn.disabled = false;

            displayAnnouncementHeading.textContent = currentAnnouncement.heading || 'Tanpa Heading';
            // Replace newlines with <br> for proper display in HTML
            displayAnnouncementContent.innerHTML = (currentAnnouncement.content || 'Tidak ada konten').replace(/\n/g, '<br>');

            if (currentAnnouncement.showTimestamp && currentAnnouncement.publishAt) {
                const publishDate = currentAnnouncement.publishAt.toDate();
                displayAnnouncementTimestamp.textContent = `Disiarkan: ${formatTimestamp(publishDate)}`;
                displayAnnouncementTimestamp.classList.remove('hidden');
            } else {
                displayAnnouncementTimestamp.classList.add('hidden');
            }

            // Update info popup for admin
            let infoText = "";
            if (currentAnnouncement.publishAt) {
                const publishDate = currentAnnouncement.publishAt.toDate();
                const now = new Date();
                if (publishDate.getTime() > now.getTime()) {
                    // Scheduled for future
                    const timeLeft = publishDate.getTime() - now.getTime();
                    const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                    
                    let countdownString = `Dalam `;
                    if (days > 0) countdownString += `${days}h `;
                    if (hours > 0) countdownString += `${hours}j `;
                    if (minutes > 0) countdownString += `${minutes}m `;
                    countdownString += `${seconds}d`; // Always show seconds

                    infoText += `Dijadwalkan: ${formatTimestamp(publishDate)} (${countdownString.trim()})\n`;
                    infoText += `Status: Belum Disiarkan`;
                } else {
                    infoText += `Disiarkan: ${formatTimestamp(publishDate)}\n`;
                    infoText += `Status: Sudah Disiarkan`;
                }
            } else {
                 infoText += `Status: Tidak Ada Timestamp`; // Should not happen with current logic, but good fallback
            }
            if (currentAnnouncement.lastEditedBy) {
                 infoText += `\nTerakhir diedit oleh: ${currentAnnouncement.lastEditedBy}`;
            }
            announcementInfoPopup.innerHTML = infoText.replace(/\n/g, '<br>');
        }
        
        // Update countdown for admin display every second
        let countdownInterval;
        function startCountdownUpdate() {
            if (countdownInterval) clearInterval(countdownInterval); // Clear existing interval
            countdownInterval = setInterval(() => {
                if (announcementManagementPage.classList.contains('active')) { // Only update if admin is on the page
                    updateAnnouncementDisplayForAdmin();
                } else {
                    clearInterval(countdownInterval); // Stop if admin leaves the page
                }
            }, 1000);
        }

        saveAnnouncementBtn.addEventListener('click', async () => {
            if (!isAdminLoggedIn || !ADMIN_UIDS.includes(currentUserId)) {
                showToast("Anda tidak memiliki izin untuk menyimpan informasi.");
                return;
            }

            const heading = announcementHeadingInput.value.trim();
            const content = announcementContentInput.value.trim();
            const showTimestamp = includeTimestampCheckbox.checked;
            const publishNow = publishNowCheckbox.checked;

            if (!heading || !content) {
                showToast("Heading dan Pengumuman tidak boleh kosong.");
                return;
            }

            let publishAtTimestamp;
            if (publishNow) {
                publishAtTimestamp = serverTimestamp(); // Set to server current time
            } else {
                const scheduledTime = scheduledPublishTimeInput.value;
                if (!scheduledTime) {
                    showToast("Harap masukkan tanggal dan waktu untuk jadwal siaran.");
                    return;
                }
                const localDate = new Date(scheduledTime);
                if (isNaN(localDate.getTime())) {
                    showToast("Format tanggal/waktu tidak valid.");
                    return;
                }
                // Pastikan waktu yang dijadwalkan tidak di masa lalu jika tidak disiarkan sekarang
                if (localDate.getTime() < new Date().getTime()) {
                    showToast("Waktu penjadwalan tidak bisa di masa lalu.");
                    return;
                }
                publishAtTimestamp = localDate; // Store as Date object, Firestore will convert
            }

            showActionLoading("Menyimpan Informasi...");
            const announcementDocRef = doc(db, `artifacts/${appId}/public/data/announcements`, 'mainAnnouncement');

            try {
                await setDoc(announcementDocRef, {
                    heading: heading,
                    content: content,
                    showTimestamp: showTimestamp,
                    publishAt: publishAtTimestamp,
                    lastEditedBy: auth.currentUser ? auth.currentUser.email : 'Unknown' // Store admin's email
                });
                showToast("Informasi berhasil disimpan.");
                // loadCurrentAnnouncementForAdminEdit() will be triggered by onSnapshot and refresh
            } catch (e) {
                console.error("Error saving announcement: ", e);
                showToast("Gagal menyimpan informasi. Coba lagi.");
            } finally {
                hideActionLoading();
            }
        });

        editCurrentAnnouncementBtn.addEventListener('click', () => {
            if (currentAnnouncement) {
                announcementHeadingInput.value = currentAnnouncement.heading || '';
                announcementContentInput.value = currentAnnouncement.content || '';
                includeTimestampCheckbox.checked = currentAnnouncement.showTimestamp || false;

                if (currentAnnouncement.publishAt && currentAnnouncement.publishAt.toDate) {
                    const publishDate = currentAnnouncement.publishAt.toDate();
                    // Check if the scheduled time is in the future.
                    // If it's in the past or current, treat as "publish now"
                    if (publishDate.getTime() > new Date().getTime()) {
                        publishNowCheckbox.checked = false;
                        scheduleTimeSection.classList.remove('hidden');
                        scheduledPublishTimeInput.value = publishDate.toISOString().substring(0, 16);
                    } else {
                        publishNowCheckbox.checked = true;
                        scheduleTimeSection.classList.add('hidden');
                        scheduledPublishTimeInput.value = '';
                    }
                } else {
                    publishNowCheckbox.checked = true; // Default to publish now if no publishAt
                    scheduleTimeSection.classList.add('hidden');
                    scheduledPublishTimeInput.value = '';
                }
                showToast("Informasi dimuat ke form untuk diedit.");
            } else {
                showToast("Tidak ada informasi untuk diedit.");
            }
        });

        deleteCurrentAnnouncementBtn.addEventListener('click', async () => {
            if (!currentAnnouncement) {
                showToast("Tidak ada informasi untuk dihapus.");
                return;
            }
            if (!isAdminLoggedIn || !ADMIN_UIDS.includes(currentUserId)) {
                showToast("Anda tidak memiliki izin untuk menghapus informasi. Silakan login sebagai admin.");
                return;
            }

            const confirmationMessage = `Yakin ingin menghapus informasi "${currentAnnouncement.heading || 'Tanpa Heading'}"? Tindakan ini tidak dapat dipulihkan!`;
            // Re-use deleteModal and its elements
            deleteModal.querySelector('.modal-content h4').textContent = "Konfirmasi Penghapusan Informasi";
            deleteModal.querySelector('p.mb-6').innerHTML = confirmationMessage;
            
            // Temporarily replace the confirm delete handler
            const originalConfirmHandler = confirmDeleteBtn.onclick; 
            const originalCancelHandler = cancelDeleteBtn.onclick;

            confirmDeleteBtn.onclick = async () => {
                showActionLoading("Menghapus Informasi...");
                const announcementDocRef = doc(db, `artifacts/${appId}/public/data/announcements`, 'mainAnnouncement');
                try {
                    await deleteDoc(announcementDocRef);
                    showToast("Informasi berhasil dihapus.");
                    // currentAnnouncement will be set to null by onSnapshot callback
                    // and the user-facing modal will revert to default
                } catch (e) {
                    console.error("Error deleting announcement: ", e);
                    showToast("Gagal menghapus informasi. Coba lagi.");
                } finally {
                    hideActionLoading();
                    hideDeleteModal();
                    // Restore original handlers
                    confirmDeleteBtn.onclick = originalConfirmHandler; 
                    cancelDeleteBtn.onclick = originalCancelHandler;
                }
            };
            cancelDeleteBtn.onclick = () => {
                hideDeleteModal();
                // Restore original handlers
                confirmDeleteBtn.onclick = originalConfirmHandler; 
                cancelDeleteBtn.onclick = originalCancelHandler;
            };

            deleteModal.classList.remove('hidden'); // Show the modal
        });

        clearAnnouncementBtn.addEventListener('click', () => {
            announcementHeadingInput.value = '';
            announcementContentInput.value = '';
            publishNowCheckbox.checked = true;
            scheduleTimeSection.classList.add('hidden');
            scheduledPublishTimeInput.value = '';
            includeTimestampCheckbox.checked = true;
            showToast("Form informasi dibersihkan.");
        });

        // --- LLM Integration for Announcement Generation ---
        generateAnnouncementBtn.addEventListener('click', async () => {
            if (!isAdminLoggedIn || !ADMIN_UIDS.includes(currentUserId)) {
                showToast("Anda tidak memiliki izin untuk membuat saran informasi AI.");
                return;
            }

            const promptText = prompt("Masukkan ide atau topik singkat untuk pengumuman (misal: 'hasil lomba', 'peringatan acara', 'info pendaftaran'):");
            if (!promptText) {
                showToast("Pembuatan dibatalkan.");
                return;
            }

            showActionLoading("Membuat saran informasi AI...");
            try {
                let chatHistory = [];
                // Construct the prompt to guide the LLM
                const llmPrompt = `Buatkan saya sebuah draf pengumuman resmi dan singkat (maksimal 2-3 paragraf) untuk aplikasi ranking ballot. Pengumuman ini akan ditampilkan kepada pengguna.
                Topiknya adalah: "${promptText}".
                Sertakan judul pengumuman yang relevan. Pisahkan judul dan isi pengumuman dengan tanda '---JUDUL_PEMISAH---'.`;

                chatHistory.push({ role: "user", parts: [{ text: llmPrompt }] });

                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will automatically provide this during runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    
                    const parts = generatedText.split('---JUDUL_PEMISAH---');
                    let generatedHeading = "Pengumuman";
                    let generatedContent = generatedText;

                    if (parts.length > 1) {
                        generatedHeading = parts[0].trim();
                        generatedContent = parts.slice(1).join('---JUDUL_PEMISAH---').trim();
                    } else if (generatedText.includes('\n')) {
                        // If no specific separator but has newlines, try to guess heading from first line
                        const firstLineBreak = generatedText.indexOf('\n');
                        generatedHeading = generatedText.substring(0, firstLineBreak).trim();
                        generatedContent = generatedText.substring(firstLineBreak + 1).trim();
                    }

                    announcementHeadingInput.value = generatedHeading;
                    announcementContentInput.value = generatedContent;
                    showToast("Saran informasi AI berhasil dibuat!");
                } else {
                    showToast("Gagal mendapatkan saran informasi AI. Coba lagi.");
                    console.error("Unexpected LLM response structure:", result);
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showToast("Terjadi kesalahan saat memanggil AI. Periksa koneksi atau coba lagi.");
            } finally {
                hideActionLoading();
            }
        });


        // --- Ranking Display (Real-time with onSnapshot) ---

        function setupRankingListeners() {
            if (currentUserId === null) return;
            isAdminLoggedIn = ADMIN_UIDS.includes(currentUserId); 

            const smpQuery = collection(db, `artifacts/${appId}/public/data/smp_mts_schools`);
            const smaQuery = collection(db, `artifacts/${appId}/public/data/sma_smk_ma_schools`);

            onSnapshot(smpQuery, (snapshot) => {
                const schools = []; 
                let latestUpdateTimestamp = null;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    schools.push({ id: doc.id, ...data });
                    if (data.lastUpdated && (!latestUpdateTimestamp || (data.lastUpdated.toDate && latestUpdateTimestamp.toDate && data.lastUpdated.toDate() > latestUpdateTimestamp.toDate()) || (!latestUpdateTimestamp && data.lastUpdated))) {
                        latestUpdateTimestamp = data.lastUpdated;
                    }
                });
                smpSchoolsData = schools; 
                // Only render if ranking page is currently active, otherwise just update data
                if (!rankingPage.classList.contains('hidden')) {
                     renderFilteredRankings(); 
                }
            }, (error) => {
                console.error("Error listening to SMP/MTs ranking:", error);
                showToast("Gagal memuat ranking SMP/MTs.");
                if (!rankingPage.classList.contains('hidden')) {
                    renderFilteredRankings(); 
                }
            });

            onSnapshot(smaQuery, (snapshot) => {
                const schools = []; 
                let latestUpdateTimestamp = null;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    schools.push({ id: doc.id, ...data });
                    if (data.lastUpdated && (!latestUpdateTimestamp || (data.lastUpdated.toDate && latestUpdateTimestamp.toDate && data.lastUpdated.toDate() > latestUpdateTimestamp.toDate()) || (!latestUpdateTimestamp && data.lastUpdated))) {
                        latestUpdateTimestamp = data.lastUpdated;
                    }
                });
                smaSchoolsData = schools; 
                // Only render if ranking page is currently active, otherwise just update data
                if (!rankingPage.classList.contains('hidden')) {
                    renderFilteredRankings(); 
                }
            }, (error) => {
                console.error("Error listening to SMA/SMK/MA ranking:", error);
                showToast("Gagal memuat ranking SMA/SMK/MA.");
                if (!rankingPage.classList.contains('hidden')) {
                    renderFilteredRankings(); 
                }
            });
        }

        // Function to decide what to show after loading animation
        function finalizeRankingDisplay() {
            // Check the current display status
            if (displayRankingActive) {
                hideLoadingAndShowContent(); // Show normal ranking content
                renderFilteredRankings(); // Populate the tables
            } else {
                loadingAnimation.classList.add('hidden'); // Hide loading
                rankingContent.classList.add('hidden'); // Ensure content is hidden
                displayOffModal.classList.remove('hidden'); // Show the "Gagal memuat data" modal
            }
        }

        function renderFilteredRankings() {
            // Update "last updated" timestamps first using the global data
            let smpLatest = null;
            if (smpSchoolsData.length > 0) {
                 smpLatest = smpSchoolsData.reduce((prev, current) => {
                    const prevDate = prev.lastUpdated ? (prev.lastUpdated.toDate ? prev.lastUpdated.toDate() : prev.lastUpdated) : null;
                    const currDate = current.lastUpdated ? (current.lastUpdated.toDate ? current.lastUpdated.toDate() : current.lastUpdated) : null;
                    if (!prevDate) return current;
                    if (!currDate) return prev;
                    return prevDate > currDate ? prev : current;
                 }).lastUpdated;
            }
            smpRankingLastUpdated.textContent = `Poin diperbarui pada: ${formatTimestamp(smpLatest)}`;

            let smaLatest = null;
            if (smaSchoolsData.length > 0) {
                smaLatest = smaSchoolsData.reduce((prev, current) => {
                    const prevDate = prev.lastUpdated ? (prev.lastUpdated.toDate ? prev.lastUpdated.toDate() : prev.lastUpdated) : null;
                    const currDate = current.lastUpdated ? (current.lastUpdated.toDate ? current.lastUpdated.toDate() : current.lastUpdated) : null;
                    if (!prevDate) return current;
                    if (!currDate) return prev;
                    return prevDate > currDate ? prev : current;
                }).lastUpdated;
            }
            smaRankingLastUpdated.textContent = `Poin diperbarui pada: ${formatTimestamp(smaLatest)}`;
            
            // Always render actual data here, as finalizeRankingDisplay controls visibility
            const filteredSmp = smpSchoolsData.filter(school =>
                school.name.toLowerCase().includes(currentSearchQuery.toLowerCase())
            );
            const filteredSma = smaSchoolsData.filter(school =>
                school.name.toLowerCase().includes(currentSearchQuery.toLowerCase())
            );

            filteredSmp.sort((a, b) => b.points - a.points);
            filteredSma.sort((a, b) => b.points - a.points);

            renderRankingTable(filteredSmp, displaySmpRanking);
            renderRankingTable(filteredSma, displaySmaRanking);
        }

        function renderRankingTable(schools, tableBodyElement) {
            tableBodyElement.innerHTML = '';
            if (schools.length === 0) {
                tableBodyElement.innerHTML = `<tr><td colspan="2" class="text-center py-4 text-gray-500">Belum ada data ranking.</td></tr>`; // Changed colspan to 2
                return;
            }

            schools.forEach((school, index) => {
                const row = tableBodyElement.insertRow();
                row.classList.add('ranking-item');
                if (index === 0 && schools[0].points > 0) {
                    row.classList.add('top-rank');
                }
                row.innerHTML = `
                    <td class="py-2 px-4 text-sm">${school.name}</td>
                    <td class="py-2 px-4 text-sm">${school.points}</td>
                `;
            });
        }

        function hideLoadingAndShowContent() {
            loadingAnimation.classList.add('hidden');
            rankingContent.classList.remove('hidden');
        }

        // --- User-Facing Announcement Logic ---
        function setupUserAnnouncementListener() {
            const announcementDocRef = doc(db, `artifacts/${appId}/public/data/announcements`, 'mainAnnouncement');
            onSnapshot(announcementDocRef, (docSnap) => {
                let currentFetchedHeading = defaultAnnouncementHeading;
                let currentFetchedContentRaw = defaultAnnouncementContent;
                let currentFetchedTimestampText = "";
                let currentFetchedTimestampVisible = false;
                let currentFetchedIsActive = false; // True if this fetch *would* display an admin-published announcement

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const publishTime = data.publishAt ? data.publishAt.toDate() : null;
                    const now = new Date();

                    if (publishTime && publishTime.getTime() <= now.getTime()) { // Is published
                        currentFetchedHeading = data.heading || defaultAnnouncementHeading;
                        currentFetchedContentRaw = data.content || defaultAnnouncementContent;
                        if (data.showTimestamp) { // Use data.showTimestamp directly
                            currentFetchedTimestampText = `Disiarkan pada: ${formatTimestamp(data.publishAt)}`;
                            currentFetchedTimestampVisible = true;
                        }
                        currentFetchedIsActive = true;
                    }
                }

                // Apply fetched content to the modal elements (regardless of visibility)
                userAnnouncementHeading.textContent = currentFetchedHeading;
                userAnnouncementContent.innerHTML = currentFetchedContentRaw.replace(/\n/g, '<br>');
                userAnnouncementTimestamp.textContent = currentFetchedTimestampText;
                if (currentFetchedTimestampVisible) {
                    userAnnouncementTimestamp.classList.remove('hidden');
                } else {
                    userAnnouncementTimestamp.classList.add('hidden');
                }

                // Decide modal visibility based on the fetched announcement status
                const isModalCurrentlyHidden = announcementModal.classList.contains('hidden');

                // Condition 1: A custom announcement just became active
                const becameActiveNow = currentFetchedIsActive && !previousUserAnnouncementIsActive;

                // Condition 2: An existing active announcement's content (heading or content) changed
                const activeContentChanged = currentFetchedIsActive && previousUserAnnouncementIsActive &&
                                             (currentFetchedHeading !== previousUserAnnouncementHeading ||
                                              currentFetchedContentRaw !== previousUserAnnouncementContentRaw);

                // Condition 3: A custom announcement that *was* active is now inactive (deleted or scheduled for future)
                const becameInactiveNow = !currentFetchedIsActive && previousUserAnnouncementIsActive;


                if (becameActiveNow || activeContentChanged) {
                    announcementModal.classList.remove('hidden'); // Show the modal (pop-up)
                } else if (becameInactiveNow) {
                    announcementModal.classList.add('hidden'); // Hide the modal
                }
                // If it's already hidden and newIsActive is false (default state), it stays hidden.
                // If it's already visible and newIsActive is true, and content didn't change (user hasn't closed it yet for this specific announcement), it stays visible.

                // Update previous state for next comparison
                previousUserAnnouncementHeading = currentFetchedHeading;
                previousUserAnnouncementContentRaw = currentFetchedContentRaw;
                previousUserAnnouncementIsActive = currentFetchedIsActive;
            }, (error) => {
                console.error("Error loading user announcement:", error);
                // On error, revert to default message and ensure modal is hidden
                userAnnouncementHeading.textContent = defaultAnnouncementHeading;
                userAnnouncementContent.innerHTML = defaultAnnouncementContent;
                userAnnouncementTimestamp.classList.add('hidden');
                announcementModal.classList.add('hidden'); // Ensure modal is hidden on error
                // Reset previous state on error to ensure re-trigger if fixed
                previousUserAnnouncementHeading = defaultAnnouncementHeading;
                previousUserAnnouncementContentRaw = defaultAnnouncementContent;
                previousUserAnnouncementIsActive = false;
            });
        }

        // Function to update display status in Firestore
        async function updateDisplayStatus(isActive) {
            if (!isAdminLoggedIn || !ADMIN_UIDS.includes(currentUserId)) {
                showToast("Anda tidak memiliki izin untuk mengubah status display.");
                return;
            }
            showActionLoading("Memperbarui status display...");
            try {
                await setDoc(appSettingsDocRef, { displayActive: isActive }, { merge: true });
                showToast(`Display ranking berhasil ${isActive ? 'diaktifkan' : 'dinonaktifkan'}.`);
            } catch (error) {
                console.error("Error updating display status:", error);
                showToast("Gagal memperbarui status display. Coba lagi.");
            } finally {
                hideActionLoading();
            }
        }

        // Listener for display status changes
        function setupDisplayStatusListener() {
            onSnapshot(appSettingsDocRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().hasOwnProperty('displayActive')) {
                    displayRankingActive = docSnap.data().displayActive;
                } else {
                    // Default to true if setting doesn't exist (first load)
                    displayRankingActive = true;
                    // Optional: create the document with default true if it doesn't exist
                    // This can be done in an async block to avoid blocking initial load
                    setDoc(appSettingsDocRef, { displayActive: true }, { merge: true }).catch(console.error);
                }
                // Update UI in admin panel if it's currently visible
                if (ballotInputPage.classList.contains('active')) {
                    updateAdminDisplayStatusUI();
                }
                // If ranking page is visible, re-finalize display based on new status
                if (!rankingPage.classList.contains('hidden')) {
                    finalizeRankingDisplay();
                }
            }, (error) => {
                console.error("Error listening to display status:", error);
                showToast("Gagal memuat status display.");
                // Fallback to active display on error to avoid blank screen
                displayRankingActive = true;
                if (ballotInputPage.classList.contains('active')) {
                    updateAdminDisplayStatusUI();
                }
                if (!rankingPage.classList.contains('hidden')) {
                    finalizeRankingDisplay();
                }
            });
        }

        // Update admin panel UI for display status
        function updateAdminDisplayStatusUI() {
            if (displayRankingActive) {
                displayStatus.textContent = "Status: Aktif";
                displayStatus.classList.remove('text-red-600');
                displayStatus.classList.add('text-green-600');
                activateDisplayBtn.disabled = true;
                deactivateDisplayBtn.disabled = false;
                activateDisplayBtn.classList.add('opacity-50', 'cursor-not-allowed'); // Apply blur
                deactivateDisplayBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                displayStatus.textContent = "Status: Nonaktif";
                displayStatus.classList.remove('text-green-600');
                displayStatus.classList.add('text-red-600');
                activateDisplayBtn.disabled = false;
                deactivateDisplayBtn.disabled = true;
                activateDisplayBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                deactivateDisplayBtn.classList.add('opacity-50', 'cursor-not-allowed'); // Apply blur
            }
        }

        // Event listeners for display control buttons
        activateDisplayBtn.addEventListener('click', () => updateDisplayStatus(true));
        deactivateDisplayBtn.addEventListener('click', () => updateDisplayStatus(false));


        // Autentikasi Firebase pertama kali saat aplikasi dimuat
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("Firebase authenticated with user ID:", currentUserId);
                isAdminLoggedIn = ADMIN_UIDS.includes(currentUserId);
                
                setupRankingListeners(); // Ini akan memicu listener data ranking
                setupUserAnnouncementListener(); // Setup listener untuk pengumuman di pop-up user
                setupDisplayStatusListener(); // Setup listener untuk status display
                // startCountdownUpdate() hanya akan dipanggil saat admin masuk ke halaman announcementManagementPage
                // di event listener goToAnnouncementManagementBtn.
            } else {
                // Jika tidak ada user yang login, coba login secara anonim
                try {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                } catch (e) {
                    console.error("Error signing in anonymously:", e);
                    showToast("Gagal melakukan autentikasi anonim. Coba lagi.");
                }
            }
        });

        // Event listener untuk menutup modal pengumuman
        closeAnnouncementBtn.addEventListener('click', () => {
            announcementModal.classList.add('hidden'); // Sembunyikan modal pengumuman

            // When user explicitly closes, mark the current active announcement (if any) as 'acknowledged'
            // by setting previous state to current fetched state. This prevents immediate re-pop for the same content.
            // The `onSnapshot` will continue to run and re-evaluate `shouldShowModal`.
            // If the content changes OR it moves from inactive to active, it will pop up again.
            previousUserAnnouncementHeading = userAnnouncementHeading.textContent;
            previousUserAnnouncementContentRaw = userAnnouncementContent.textContent.replace(/<br>/g, '\n'); // Convert back to raw for accurate comparison
            previousUserAnnouncementIsActive = (userAnnouncementHeading.textContent !== defaultAnnouncementHeading ||
                                               userAnnouncementContent.textContent.replace(/<br>/g, '\n') !== defaultAnnouncementContent);
        });

        // Pastikan header mengambil ruang (untuk min-h-screen-minus-header)
        document.addEventListener('DOMContentLoaded', () => {
            const headerHeight = document.querySelector('.header').offsetHeight;
            document.documentElement.style.setProperty('--header-height', `${headerHeight}px`);
        });
        window.addEventListener('resize', () => {
            const headerHeight = document.querySelector('.header').offsetHeight;
            document.documentElement.style.setProperty('--header-height', `${headerHeight}px`);
        });

    </script>
</body>
</html>

